---
layout:       post
title:        "åˆ†å¸ƒå¼å”¯ä¸€ID"
author:       "mjTree"
header-style: text
catalog:      true
tags:
    - java
---

><small>æ›´æ–°äºï¼š2024-04-07 20:00</small>


### ä¸€ã€åˆ†å¸ƒå¼ID

åˆ†å¸ƒå¼IDï¼ˆDistributed IDï¼‰æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ç”¨äºå”¯ä¸€æ ‡è¯†å’ŒåŒºåˆ†ä¸åŒå®ä½“æˆ–æ•°æ®çš„ä¸€ç§æ ‡è¯†ç¬¦ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºç³»ç»Ÿçš„åˆ†å¸ƒæ€§å’Œå¹¶å‘æ€§ï¼Œé€šå¸¸éœ€è¦ä¸ºæ¯ä¸ªæ•°æ®è®°å½•æˆ–å®ä½“åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼Œä»¥ç¡®ä¿æ•°æ®çš„å”¯ä¸€æ€§å’Œä¸€è‡´æ€§ã€‚  


### äºŒã€å¸¸è§æ–¹æ¡ˆ

#### 1ã€uuid
uuidçš„åº•å±‚æ˜¯ä¸€ç»„32ä½æ•°çš„16è¿›åˆ¶æ•°å­—æ„æˆï¼Œç”Ÿæˆè¿‡ç¨‹è¦ç”¨åˆ°macåœ°å€ã€æ—¶é—´æˆ³ã€èŠ¯ç‰‡IDç å’Œéšæœºæ•°ç­‰ï¼Œç†è®ºä¸Šå¾ˆéš¾ç”¨å®Œã€‚ä¸šåŠ¡åœºæ™¯ï¼šå¯ç”¨äºæ™®é€šèµ„æºçš„å…‘æ¢ç ä½¿ç”¨ï¼Œæ¯”å¦‚è¯´ç½‘ç«™åšä¸€äº›å°æ´»åŠ¨é€ä¼˜æƒ å·äº†ï¼Œå¯ä»¥å½“ä½œå¡åˆ¸å…‘æ¢ç ä¹‹ç±»çš„ã€‚ä¹Ÿå¯ä»¥è¡¨ç¤ºåˆ†å¸ƒå¼ä¸‹æœºå™¨çš„èŠ‚ç‚¹idã€æ¶ˆæ¯çš„idã€è¯·æ±‚æ—¥å¿—è¿½è¸ªè®°å½•ç­‰ç­‰ã€‚  

```java
import java.util.UUID;
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class MyUUID {
    public static void main(String[] args) throws InterruptedException {
        ThreadPoolExecutor poolExecutor = new ThreadPoolExecutor(3, 10, 0, TimeUnit.SECONDS, new ArrayBlockingQueue<>(20));
        for (int i = 0; i < 20; i++) {
            if (poolExecutor.getActiveCount() <= poolExecutor.getMaximumPoolSize()) {
                poolExecutor.execute(() -> {
                    try {
                        System.out.println(getUUID());
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                });
            }
        }
        TimeUnit.SECONDS.sleep(3);
        poolExecutor.shutdown();
    }

    public static String getUUID() {
        return UUID.randomUUID().toString().replace("-","");
    }
}
```

#### 2ã€database
æ¶‰åŠåˆ°æ•°æ®åº“çš„æ–¹æ¡ˆï¼Œä¸€èˆ¬ä¸æ˜¯å¾ˆæ¨èã€‚ç³»ç»Ÿéƒ½å¼€å§‹ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿäº†ï¼Œæ•°æ®åº“è‚¯å®šä¹Ÿé›†ç¾¤äº†ï¼Œå†å»ä½¿ç”¨æ•°æ®åº“å¸®å¿™æœ‰ç‚¹æœ¬æœ«å€’ç½®äº†ã€‚è€Œä¸”é€šè¿‡javaæœåŠ¡ä»£ç è°ƒç”¨mysqléƒ½æ˜¯å€Ÿç”¨ORMæ¡†æ¶å’Œspringbootæ¡†æ¶å¸®å¿™ï¼Œä¸ç›´æ¥ä»£ç æ“ä½œæ•°æ®åº“è¡¨è®°å½•è¯»å–idã€‚  

#### 3ã€redis
ç›®å‰å…¬å¸é€šè¿‡Redisè‡ªå¢å‘½ä»¤ä¸æ—¶é—´æˆ³ç›¸ç»“åˆæ¥æä¾›çº¿ç¨‹å®‰å…¨çš„åˆ†å¸ƒå¼å”¯ä¸€æ ‡è¯†ç¬¦ç”Ÿæˆç­–ç•¥ã€‚åŸç†å°±æ˜¯é€šè¿‡redisçš„åŸå­æ€§è‡ªå¢å‘½ä»¤(å•çº¿ç¨‹)+æ—¶é—´æˆ³+å¡«å……çš„æ•°å­—(é«˜ä½è¡¥0ã€è‡ªå·±å¡«ä¸€éƒ¨åˆ†ã€éšæœºæ•°)ç»„æˆä¸€ä¸ª32ä½çš„æ•°å­—ã€‚å› ä¸ºæ˜¯æœ‰åºçš„idï¼Œå¯ç”¨äºå½“ä½œä¸»é”®idï¼Œè®¢å•idç­‰ã€‚  

```java
//<dependency>
//    <groupId>redis.clients</groupId>
//    <artifactId>jedis</artifactId>
//    <version>3.7.0</version>
//</dependency>

import redis.clients.jedis.Jedis;
import redis.clients.jedis.JedisPool;
import redis.clients.jedis.JedisPoolConfig;

import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class RedisID {
    private static volatile JedisPool jedisPool = null;

    private RedisID() {}

    public static JedisPool getJedisPoolInstance() {
        if (null == jedisPool) {
            synchronized (RedisID.class) {
                if (null == jedisPool) {
                    JedisPoolConfig poolConfig = new JedisPoolConfig();
                    poolConfig.setMaxTotal(1000);
                    poolConfig.setMaxIdle(32);
                    poolConfig.setMaxWaitMillis(100 * 1000);
                    poolConfig.setTestOnBorrow(true);
                    jedisPool = new JedisPool(poolConfig, "127.0.0.1", 6379);
                }
            }
        }
        return jedisPool;
    }

    public static void release(JedisPool jedisPool, Jedis jedis) {
        if (null != jedis) {
            Jedis jedis2 = null;
            try {
                jedis2 = jedisPool.getResource();
            } finally {
                jedis2.close();
            }
        }
    }

    public static String getRedisID(Jedis jedis) {
        return String.valueOf(jedis.incr("id"));
    }

    public static void main(String[] args) throws InterruptedException {
        JedisPool jedisPool = RedisID.getJedisPoolInstance();
        Jedis jedis = null;
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(3, 8, 0, TimeUnit.SECONDS, new ArrayBlockingQueue<>(10));
        for (int i = 0; i < 10; i++) {
            if (threadPoolExecutor.getActiveCount() <= 8) {
                threadPoolExecutor.execute(() -> {
                    try {
                        System.out.println(getRedisID(jedisPool.getResource()));
                    } catch (Exception e) {
                        e.printStackTrace();
                    } finally {
                        RedisID.release(jedisPool, jedis);
                    }
                });
            }
        }
        TimeUnit.SECONDS.sleep(2);
        threadPoolExecutor.shutdown();
    }
}
```

#### 4ã€zookeeper
é€šè¿‡åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹æ¥å®Œæˆï¼Œä¸åŒå®¢æˆ·ç«¯æ¯æ¬¡åªèƒ½ä¸€ä¸ªåˆ›å»ºèŠ‚æ¥è·å–èŠ‚ç‚¹pathæ¥å¾—åˆ°å”¯ä¸€idã€‚ä¸šåŠ¡åœºæ™¯ï¼šåšè®¢å•å·ï¼Œæ•°æ®åº“è¡¨ä¸»é”®ã€‚  

```java
//<dependency>
//    <groupId>org.apache.zookeeper</groupId>
//    <artifactId>zookeeper</artifactId>
//    <version>3.7.0</version>
//</dependency>

import org.apache.zookeeper.*;
import java.util.concurrent.*;

public class ZooKeeperID {
    //  zkçš„è¿æ¥ä¸²
    private static final String IP = "127.0.0.1:2181";
    //  è®¡æ•°å™¨å¯¹è±¡
    private static CountDownLatch countDownLatch = new CountDownLatch(1);
    //  è¿æ¥å¯¹è±¡
    private static ZooKeeper zooKeeper;

    public static String generateId() throws KeeperException, InterruptedException {
        return zooKeeper.create("/id", new byte[0], ZooDefs.Ids.OPEN_ACL_UNSAFE, CreateMode.EPHEMERAL_SEQUENTIAL).substring(3);
    }


    public static void main(String[] args) throws Exception {
        zooKeeper = new ZooKeeper(IP, 5000, new ZKWatcher());
        countDownLatch.await();
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(5, 5, 0, TimeUnit.SECONDS, new ArrayBlockingQueue<>(10));
        for (int i = 0; i < 10; i++) {
            threadPoolExecutor.execute(() -> {
                try {
                    System.out.println(generateId());
                } catch (Exception e) {
                    e.printStackTrace();
                }
            });
        }
        TimeUnit.SECONDS.sleep(2);
        threadPoolExecutor.shutdown();
    }

    static class ZKWatcher implements Watcher {
        @Override
        public void process(WatchedEvent watchedEvent) {
            countDownLatch.countDown();
            System.out.println("zkçš„ç›‘å¬å™¨" + watchedEvent.getType());
        }
    }
}
```

#### 5ã€é›ªèŠ±ç®—æ³•
1ä½ç¬¦å·ä½+41ä½æ—¶é—´æˆ³+10ä½æ•°æ®æœºå™¨ä½+12ä½æ¯«ç§’å†…çš„åºåˆ—ã€‚æœºå™¨ä½æ˜¯æœºæˆ¿id+æœºæˆ¿é‡Œé¢æœåŠ¡å™¨idå‡‘çš„ï¼Œåé¢åºåˆ—æ˜¯ä¿è¯1så†…å¤šå¹¶å‘ã€‚

```java
import java.util.concurrent.ArrayBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class Snowflakes {
    //ä¸‹é¢ä¸¤ä¸ªæ¯ä¸ª5ä½ï¼ŒåŠ èµ·æ¥å°±æ˜¯10ä½çš„å·¥ä½œæœºå™¨id
    private long workerId;      //å·¥ä½œid
    private long datacenterId;  //æ•°æ®id
    private long sequence;      //12ä½çš„åºåˆ—å·

    public Snowflakes(long workerId, long datacenterId, long sequence) {
        // sanity check for workerId
        if (workerId > maxWorkerId || workerId < 0) {
            throw new IllegalArgumentException(String.format("worker Id can't be greater than %d or less than 0", maxWorkerId));
        }
        if (datacenterId > maxDatacenterId || datacenterId < 0) {
            throw new IllegalArgumentException(String.format("datacenter Id can't be greater than %d or less than 0", maxDatacenterId));
        }
        System.out.printf("worker starting. timestamp left shift %d, datacenter id bits %d, worker id bits %d, sequence bits %d, workerid %d \n",
                timestampLeftShift, datacenterIdBits, workerIdBits, sequenceBits, workerId);

        this.workerId = workerId;
        this.datacenterId = datacenterId;
        this.sequence = sequence;
    }

    //åˆå§‹æ—¶é—´æˆ³
    private long twepoch = 1288834974657L;
    //é•¿åº¦ä¸º5ä½
    private long workerIdBits = 5L;
    private long datacenterIdBits = 5L;
    private long maxWorkerId = -1L ^ (-1L << workerIdBits);
    private long maxDatacenterId = -1L ^ (-1L << datacenterIdBits);
    private long sequenceBits = 12L;    //åºåˆ—å·idé•¿åº¦
    private long sequenceMask = -1L ^ (-1L << sequenceBits);    //åºåˆ—å·æœ€å¤§å€¼

    //å·¥ä½œidéœ€è¦å·¦ç§»çš„ä½æ•°ï¼Œ12ä½
    private long workerIdShift = sequenceBits;
    //æ•°æ®idéœ€è¦å·¦ç§»ä½æ•° 12+5=17ä½
    private long datacenterIdShift = sequenceBits + workerIdBits;
    //æ—¶é—´æˆ³éœ€è¦å·¦ç§»ä½æ•° 12+5+5=22ä½
    private long timestampLeftShift = sequenceBits + workerIdBits + datacenterIdBits;

    //ä¸Šæ¬¡æ—¶é—´æˆ³ï¼Œåˆå§‹å€¼ä¸ºè´Ÿæ•°
    private long lastTimestamp = -1L;

    public long getWorkerId() {
        return workerId;
    }

    public long getDatacenterId() {
        return datacenterId;
    }

    public long getTimestamp() {
        return System.currentTimeMillis();
    }

    //ä¸‹ä¸€ä¸ªIDç”Ÿæˆç®—æ³•
    public synchronized long nextId() {
        long timestamp = timeGen();
        //è·å–å½“å‰æ—¶é—´æˆ³å¦‚æœå°äºä¸Šæ¬¡æ—¶é—´æˆ³ï¼Œåˆ™è¡¨ç¤ºæ—¶é—´æˆ³è·å–å‡ºç°å¼‚å¸¸
        if (timestamp < lastTimestamp) {
            System.err.printf("clock is moving backwards.  Rejecting requests until %d.", lastTimestamp);
            throw new RuntimeException(String.format("Clock moved backwards.  Refusing to generate id for %d milliseconds",
                    lastTimestamp - timestamp));
        }
        //è·å–å½“å‰æ—¶é—´æˆ³å¦‚æœç­‰äºä¸Šæ¬¡æ—¶é—´æˆ³ï¼ˆåŒä¸€æ¯«ç§’å†…ï¼‰ï¼Œåˆ™åœ¨åºåˆ—å·åŠ ä¸€ï¼›å¦åˆ™åºåˆ—å·èµ‹å€¼ä¸º0ï¼Œä»0å¼€å§‹ã€‚
        if (lastTimestamp == timestamp) {
            sequence = (sequence + 1) & sequenceMask;
            if (sequence == 0) {
                timestamp = tilNextMillis(lastTimestamp);
            }
        } else {
            sequence = 0;
        }
        //å°†ä¸Šæ¬¡æ—¶é—´æˆ³å€¼åˆ·æ–°
        lastTimestamp = timestamp;

        /**
         * è¿”å›ç»“æœï¼š
         * (timestamp - twepoch) << timestampLeftShift) è¡¨ç¤ºå°†æ—¶é—´æˆ³å‡å»åˆå§‹æ—¶é—´æˆ³ï¼Œå†å·¦ç§»ç›¸åº”ä½æ•°
         * (datacenterId << datacenterIdShift) è¡¨ç¤ºå°†æ•°æ®idå·¦ç§»ç›¸åº”ä½æ•°
         * (workerId << workerIdShift) è¡¨ç¤ºå°†å·¥ä½œidå·¦ç§»ç›¸åº”ä½æ•°
         * | æ˜¯æŒ‰ä½æˆ–è¿ç®—ç¬¦ï¼Œä¾‹å¦‚ï¼šx | yï¼Œåªæœ‰å½“xï¼Œyéƒ½ä¸º0çš„æ—¶å€™ç»“æœæ‰ä¸º0ï¼Œå…¶å®ƒæƒ…å†µç»“æœéƒ½ä¸º1ã€‚
         * å› ä¸ºä¸ªéƒ¨åˆ†åªæœ‰ç›¸åº”ä½ä¸Šçš„å€¼æœ‰æ„ä¹‰ï¼Œå…¶å®ƒä½ä¸Šéƒ½æ˜¯0ï¼Œæ‰€ä»¥å°†å„éƒ¨åˆ†çš„å€¼è¿›è¡Œ | è¿ç®—å°±èƒ½å¾—åˆ°æœ€ç»ˆæ‹¼æ¥å¥½çš„id
         */
        return ((timestamp - twepoch) << timestampLeftShift) |
                (datacenterId << datacenterIdShift) |
                (workerId << workerIdShift) |
                sequence;
    }

    //è·å–æ—¶é—´æˆ³ï¼Œå¹¶ä¸ä¸Šæ¬¡æ—¶é—´æˆ³æ¯”è¾ƒ
    private long tilNextMillis(long lastTimestamp) {
        long timestamp = timeGen();
        while (timestamp <= lastTimestamp) {
            timestamp = timeGen();
        }
        return timestamp;
    }

    //è·å–ç³»ç»Ÿæ—¶é—´æˆ³
    private long timeGen() {
        return System.currentTimeMillis();
    }

    public static void main(String[] args) throws InterruptedException {
        Snowflakes worker = new Snowflakes(2, 3, 4);
        ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor
                (2, 10, 0, TimeUnit.SECONDS, new ArrayBlockingQueue<>(20));
        for (int i = 0; i < 30; i++) {
            if (threadPoolExecutor.getActiveCount() <= 10) {
                threadPoolExecutor.execute(() -> {
                    try {
                        System.out.println(worker.nextId());
                    } catch (Exception e) {
                        e.printStackTrace();
                    }
                });
            }
        }
        TimeUnit.SECONDS.sleep(2);
        threadPoolExecutor.shutdown();

        /*for (int i = 0; i < 30; i++) {
            System.out.println(worker.nextId());
        }*/
    }
}
```

#### 5ã€å…¶ä»–å¼€æºå·¥å…·
è¿˜æœ‰å…¶ä»–å¤§å‚æä¾›çš„ç»„ä»¶å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œä¾‹å¦‚æ»´æ»´çš„`TinyID`ã€ç™¾åº¦çš„`Uidgenerator`ã€ç¾å›¢çš„`Leaf`ç­‰ã€‚  


### ä¸‰ã€å°ç»“
åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆIDï¼‰æ˜¯ä¸€ä¸ªå…³é”®é—®é¢˜ã€‚æœ¬æ–‡ä»‹ç»äº†å‡ ç§å¸¸è§çš„åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹æ¡ˆï¼ŒåŒ…æ‹¬ä½¿ç”¨UUIDã€Redisã€Zookeeperã€é›ªèŠ±ç®—æ³•ç­‰æŠ€æœ¯ã€‚ç”±äºä¸åŒçš„åˆ†å¸ƒå¼IDç”Ÿæˆæ–¹æ¡ˆå„æœ‰ä¼˜ç¼ºç‚¹ï¼Œéœ€è¦æ ¹æ®å…·ä½“ä¸šåŠ¡éœ€æ±‚å’Œç¯å¢ƒæ¥é€‰æ‹©åˆé€‚çš„æ–¹æ¡ˆã€‚  


<img src="/img/biology/microcebus-berthae.png" alt="è´æ°å€­ç‹çŒ´" width="40%" height="40%">  

```text
è´æ°å€­ç‹çŒ´
    è´æ°å€­ç‹çŒ´ğŸ’ï¼šä½“é•¿9-11å˜ç±³ï¼Œå°¾é•¿12-14å˜ç±³ï¼Œä½“é‡30å…‹ã€‚è¿™ä¸ªç‰©ç§å…·æœ‰éå¸¸å¤§çš„å‰å‘çœ¼ç›ï¼Œå…·æœ‰å¾ˆå¼ºçš„å¤œè§†åŠŸ
    èƒ½ã€‚ä¸Šä½“æ¯›çš®å‘ˆçº¢æ£•è‰²ï¼ŒèƒŒéƒ¨çš„ä¸­çº¿æœ‰ä¸€æ¡é»‘è‰²æ¡çº¹å»¶ä¼¸è‡³å°¾éƒ¨ã€‚ä¸‹ä½“æ¯›çš®æ˜¯å¥¶æ²¹è‰²æˆ–æµ…ç°è‰²ã€‚å¤´éƒ¨æœ‰æ˜æ˜¾çš„æ ‡è®°ï¼Œ
    é¼»å­ä¸Šæ–¹æœ‰ä¸€ä¸ªæ²‰é—·çš„ç™½è‰²æ–‘å—ï¼Œçœ¼ç›å‘¨å›´æœ‰è‚‰æ¡‚ç¯ã€‚åƒå…¶ä»–çš„å€­ç‹çŒ´ä¸€æ ·ï¼Œæœ‰ä¸€æ¡é•¿å°¾å·´ï¼Œè€³æœµæ¯”è¾ƒå¤§å¹¶è£¸éœ²æ— æ¯›
    ã€‚å®ƒä»¬å‡ºæ²¡äºæ½®æ¹¿çš„çƒ­å¸¦é›¨æ—ï¼Œæ ‘æ –ï¼Œç¾¤å±…ï¼Œé€šå¸¸ç»“å¯¹ç”Ÿæ´»åœ¨å°æºªæˆ–æ²³è¾¹ã€‚ä»¥æ°´æœå’Œè™«å­ä¸ºä¸»é£Ÿã€‚ç™½å¤©èº²åœ¨æ ‘æ´ä¸­ï¼Œ
    å‚æ™šæ—¶ç­‰åˆ°æ—¥è½æ‰ä¼šæ´»éƒ½ï¼Œæ˜¯ä¸€ç§åœ¨å¤œé—´æ´»åŠ¨çš„å­¤ç‹¬è€…ã€‚é€šè¿‡æ ‘æœ¨å’Œä½å±‚æ¤è¢«ï¼Œå¯»æ‰¾æ˜†è™«ã€æ°´æœã€å£è™å’Œå˜è‰²é¾™ç­‰
    å°å‹çˆ¬è¡ŒåŠ¨ç‰©ã€‚å®ƒä»¬ä¸»è¦é£Ÿç‰©æ¥æºæ˜¯ç”±è›¾èœ¡è‰å¹¼è™«äº§ç”Ÿçš„å«ç³–åˆ†æ³Œç‰©(æˆ–ç§°â€œèœœéœ²â€)ã€‚ç”±äºéæ³•é‡‡ä¼æœ¨æé€ æˆçš„æ –æ¯
    åœ°é­åˆ°ç ´åä»¥åŠå†œä¸šæ‰©å¼ ï¼Œè¯¥ç‰©ç§æœ‰ç­ç»çš„å±é™©ã€‚

2014å¹´æ¿’å±ç‰©ç§çº¢è‰²åå½•ver3.1â€”â€”æ¿’å±ï¼ˆENï¼‰ã€‚ 
```


[**è€åšå®¢åŸæ–‡é“¾æ¥**](https://blog.csdn.net/m0_37713821/article/details/110016703)  

